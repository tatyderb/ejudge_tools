# Скрипты обработки результатов контестов ejudge

Для каждого контеста делается:

* Разбиение пользователей по группам
* построение таблиц результатов ОК посылок в количествах посылок и в % к количеству студентов в группе:
    * csv файл
    * html таблица
    * вывод на экран в читаемом виде
* построение графиков:
    * сводная столбцовая диаграмма по задачам (1 задача - 1 столбец, в каждом столбце цветом выделен вклад каждой группы), 1 график
    * столбцовая диаграмма каждой группы (1 задача - 1 столбец, только эта группа), много графиков
    * круговая диаграмма каждой задачи (сектора - количество решений из групп, вариант показа только ОК решений и показа кроме ОК решений доли студентов, которые задачу не решили)
    
## Требования

* python 3.5+
* matplotlib (только для построения графиков, с ключом `--text_only` не требуется)
* jinja (только для построения таблиц в html формате)

## Примеры запуска

```cpp
python .\ej_plot_contest.py cfg_2019.json
python .\ej_plot_contest.py cfg_2019.json FRTK
python .\ej_plot_contest.py cfg_2019.json FRTK dec
python .\ej_plot_contest.py cfg_2019.json --text_only

python .\make_html.py .\data\2019\FAKI_template.html .\data\2019\FAKI.html
```

### USAGE ej_plot_contest.py

```cpp
        .\ej_plot_contest.py cfg_2019.json FRTK dec --text_only

Calculate statistics for all Ejudge contests described into config json

positional arguments:
  config         config in json format
  department     Department name in config dictionary (default: None)
  stage          stage name in config dictionary (default: None)

optional arguments:
  -h, --help     show this help message and exit
  --config_only  prevent any data processing, only print resulted config, for
                 debug only! (default: False)
  --text_only    prevent prot data, use if no matplotlib (default: False)
  --show_plots   show all plots interactively in addition to saving all images
                 (default: False)
  -v, --verbose  increase verbosity (default: False)
```

### USAGE make_html.py

```cpp
make_html.py jinja_template output_html
```

## Входные данные

Обрабатываются или dump runs, или statement table.

CSV файл указывается в поле `file_data` конфига.

**csv файл принимает как разделитель `,` или `;`  и пытается подобрать какой из этих разделителей подойдет для чтения файла**.

### Dump runs

Сохраните результаты посылок в csv формате: Dump data / Dump runs in CSV format

Получите примерно такой файл:
```cpp
Run_Id,Time,Nsec,Time2,Date,Year,Mon,Day,Hour,Min,Sec,Dur,Dur_Day,Dur_Hour,Dur_Min,Dur_Sec,Size,IPV6_Flag,IP,SSL_Flag,Sha1,User_Id,User_Login,User_Name,User_Inv,User_Ban,User_Lock,Prob,Variant,Lang,Content_Type,Stat_Short,Status,Score,Score_Adj,Test,Import_Flag,Hidden_Flag,RO_Flag,Locale_Id,Pages,Judge_Id,
13,1576083162,947773000,20191211195242,20191211,2019,12,11,19,52,42,0,0,0,0,0,327,0,95.143.216.192,0,d7ad04e8952506666bad4aa4a94af92aa5ed4d2d,9755,Yozh4,,I,,,D-DPQE,7,gcc-vg,,CF,Check failed,-1,0,0,1,0,1,0,0,0,0
14,1576087452,897053000,20191211210412,20191211,2019,12,11,21,4,12,0,0,0,0,0,229,0,95.143.216.192,0,0ebbc95dd197fbe2028fd32c1fad0c0bbbedebd0,9755,Yozh4,,I,,,D-DPQE,1,gcc-vg,,OK,OK,40,0,5,1,0,1,0,0,0,0
15,1576087453,314621000,20191211210413,20191211,2019,12,11,21,4,13,0,0,0,0,0,503,0,95.143.216.192,0,ca233b1b2c2cdd21fcf4a3d9649591b666f8a3a9,9755,Yozh4,,I,,,D-DPQE,2,gcc-vg,,OK,OK,40,0,5,1,0,1,0,0,0,0
16,1576087453,566589000,20191211210413,20191211,2019,12,11,21,4,13,0,0,0,0,0,1387,0,95.143.216.192,0,b1e8a88def91baa7ee68c1d4845e6d0451dc3e68,9755,Yozh4,,I,,,D-DPQE,3,gcc-vg,,OK,OK,40,0,5,1,0,1,0,0,0,0
```
Используемые поля:

| Поле | Где используется |
|----|------|
| User_Login | Логин пользователя, обязательный, по нему идет распределение по группам. |
| Prob | Название задачи (short_name) из serve.cfg |
| Stat_Short | Результат посылки, учитываются только OK статусы |
| Time | timestamp посылки, используется для отсекания дорешивания, если указано поле `duration` в конфиге |
| User_Inv | Статус, что пользователь invisible, посылки таких пользователей не учитываются в статистике |

### Standings

Сделайте из таблицы результатов CSV файл с разделителем `,` или `;`.

**Если нужны только полностью решенные задачи, уберите руками баллы за частично решенные задачи. В случае задания таблицы результатов задача считается решенной, если у нее есть ненулевые баллы.**

В конфиге укажите `"statement_table": true`

## Разделение по группам

Скрипты созданы для создания статистики по группам.

Группа определяется по следующему алгоритму:

* Если в файле данных есть поле `Group`, то берется его значение.
* Иначе из списка пользователей (если он задан)
* Иначе из логина по указанному префиксу и количеству символов в номере группы.

### Список пользователей

В конфиге укажите в поле `login_list` путь к CSV файлу с разделителем `,` или `;`.

Можно получить Dump data / Dump users in CSV format.

В файле должны быть поля `Login` и `Group`.

У вас контест со свободной регистрацией и логины не по шаблону? Используйте список логинов, добавьте в него поле `Group` и заполните его вручную.

### Номер группы указан в логине

Логин разбирается по маске - префикс, далее идентификатор группы указанной длины.

Префикс и длина задаются в конфиге, например для разбора логинов вида `ed95070512` часть `ed950` общая у всех студенческих логинов, далее `705` идентификатор группы длины 3, далее идентификатор студента. Для таких логинов задайте в конфиге следующие поля:
```cpp
"login_prefix":"ed950",
"login_group_len":3,
```
**Логины, не содержащие префикс, в статистике не учитываются.**

### Мне не нужно разделять на группы

Укажите логины в виде списка и проставьте всем одно и то же значение в поле `Group`.

## Файл конфигурации

Файл можно указать для 1 или нескольких контестов.

Конфигурация хранится в формате json.

### Поля конфига

| Поле | Значение | Значение по умолчанию |
|----|----|----|
| output_dir | путь к директории результатов относительно файла конфигурации (или абсолютный путь)  | `.` |
| department | название факультета, используется в создании директории результата и в заголовках таблиц и графиков | *обязательное* |
| dir | в этой директории ищутся файлы данных | `.` |
| stage | имя теста, используется для обработки данных входного тестирования и двух контрольных (test, oct, dec) | *обязательное* |
| file_data | имя файла данных | *обязательное*  |
| problems | фильтр на те задачи, по которым будем строить статистику | |
| login_list | список логинов и групп | |
| login_prefix | префикс логина (для определения номера группы); если логин не начинается с этого префикса, его результаты игнорируются | |
| login_group_len | количество символов, которые идентифицируют группу в логине пользователя | |
| preps | словарь группа:преподаватель, можете оставить пустую строку в виде идентификатора преподавателя | *обязательное*  |
| duration | все посылки после указанного времени в "hh:mm" будут исключены из статистики как дорешивание | |
| statement_table | таблица данных - это не dump runs, а таблица результатов, преобразованная в csv формат | |

Название задачи может быть с суффиксом факультета. В этом случае рекомендуется в фильтре перечислить названия без указания суффикса факультета. Тогда в таблицах и графиках название задачи будет писаться в кратком виде, без суффикса факультета.

### Конфиг для 1 контеста

Пример:
```cpp
{
"department":"DPQE",
"login_prefix":"ed950",
"login_group_len":3,
"problems":"C- Cmem- D- F- E- E_mem-",
"preps":{
        "705":"Иванов",
        "702":"Петров",
        "806":"Сидоров",
        "319":"Кузнецов"
    }
}
```

### Конфиг для нескольких контестов

Конфиг для нескольких контестов может быть иерархическим с переопределением полей. Например:

<details>
  <summary>Click to expand!</summary>
  
```cpp
{
    "output_dir": "res",
    "department": {
        "FAKI": {
            "dir":"FAKI",
            "stage": {
                "test": {
                    "file_data": "2019test_FAKI_cpp_911155.txt",
                    "problems":"triangle elevator words_freq shop sort spaceship mission",
                    "login_list": "FAKI_groups_test1.csv"
                },
                "oct": {
                    "duration":"3:30",
                    "file_data": "2019oct_FAKI_cpp_990112.txt",
                    "problems":"dumbell race stratrix cylinders goblins rabbitrain rivers icehaulers perforaptor",
                    "login_prefix": "k1s"
                },
                "dec": {
                    "duration":"3:30",
                    "file_data": "2019dec_FAKI_cpp_990107.txt",
                    "problems":"foodforce fitnesscat fedcats catfarm reedcat irbis petnames rendezvous",
                    "login_prefix": "k2s"
                }
            },
            "login_prefix": "",
            "login_group_len": 3,
            "preps": {
                "934": "Алексеев",
                "935": "Борисов",
                "936": "Васюков",
                "939": "Григорьев",
                "933": "Дмитриев",
                "932": "Егоров",
                "931": "Яковлев"
            }
        },
        "FIVT": {
            "dir":"FIVT",
            "stage": {
                "test": {
                    "file_data":"2019test_FIVT_905101.txt",
                    "problems":"",
                    "login_list":"FIVT_test_groups.txt"
                },
                "oct": {
                    "file_data": "2019oct_FIVT_990010.txt",
                    "problems": "B AC- AD- AE- AF- AG- AS- AS2- AH-"
                },
                "dec": {
                    "duration":"3:30",
                    "file_data": "2019dec_FIVT_990011.txt",
                    "problems": "B C- Cmem- D- E- F- mem- G-"
                }
            },
            "login_prefix": "ed950",
            "login_group_len": 3,
            "preps":{
                "320":"Кузнецов",
                "804":"Гончаров",
                "701":"Ткачук",
                "705":"Мельников"
            }
        }
    }
}
```
</details>

## Результаты

Результаты представляются в виде таблиц в CSV и HTML формате и графиков (столбцовых диаграмм и круговых диаграмм) в формате png. Данные записываются по директориям согласно файлу конфигурации.

### Директории результатов

Все директории результатов создаются, если их не было.

Результаты кладутся в директорию, заданную в поле `output_dir` **относительно директории, где лежит файл конфигурации**.

В ней создаются директории с именами факультетов (поле `department`), в них директории со значениями поля `stage`. То есть, если конфиг `cfg_dir/cfg.json`, то в результате получим такую структуру файлов для факультетов FAKI и FIVT и контрольными (stage) test, oct, dec:

```cpp
cfg_dir
+ cfg.json
+ FAKI          - подразумевается, что тут будут лежать входные данные
  + res  
    + FAKI
      + test
      + oct
      + dec
+ FIVT          - подразумевается, что тут будут лежать входные данные
  + res  
    + FIVT
      + test
      + oct
      + dec
```

В директориях test, oct и dec будут находиться графики и таблицы в csv и html формате.

## Таблицы

Таблицы представлены как в CSV, так и в HTML формате (для вставки в отчеты с помощью шаблонов jinja).

### CSV файлы

Файл содержит сводную таблицу по всем задачам в абсолютных значениях и в процентах к общему количеству студентов, успешно писавших контест.

Столбцы:

* **group** - группа с преподавателем; взяты из поля `preps` конфига
* **students** - количество студентов в группе, которые успешно писали контест (есть хоть одна ОК посылка или решена хоть одна задача в таблице результатов).
* далее идут названия задач, если задан фильтр по задачам, то именно в том порядке, что задан; пишется количество полностью решенных задач (ОК посылка в дампе посылок или **хоть какие ненулевые очки** в таблице результатов)
* далее название задач со знаком `%`; указывается процент правильных решений к количеству студентов в колонке students (если кто-то дважды послал решение и дважды получил ОК посылку, то они посчитаются как 2 разных ОК решения).

Нижняя строка - сумма по всей таблице для данной колонки.

### HTML файлы

Таблица абсолютных значений и таблица процентов решения задач.

Таблица из CSV файла разнесена на 2 разные таблицы. В обоих два первых столбца - названия групп и количество студентов в группе.

Последняя строка - сумма по столбцу.

## Графики

### Общая bar chart

По каждой задаче строится столбец, из подстолбцов групп.

Горизонтальная ось - названия задач, вертикальная ось - количество решений.

### bar chart по группам

По каждой группе строится диаграмма.

Горизонтальная ось - названия задач, вертикальная ось - количество решений.

### pie chart по задачам

Для каждой задачи строятся 2 круговых диаграммы (в разных файлах) - количество решений по группам без сектора не решивших задачу и количество решений по группам с сектором количества студентов, которые не решили задачу (во всех группах сразу).